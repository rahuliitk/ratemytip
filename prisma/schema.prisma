// prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ════════════════════════════════════════
// ADMIN USERS (Phase 1: only admins have accounts)
// ════════════════════════════════════════

model AdminUser {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  role          AdminRole @default(MODERATOR)
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  moderationActions ModerationAction[]
  reviewActions     ReviewAction[]
  claimReviews      ClaimRequest[]

  @@map("admin_users")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
}

// ════════════════════════════════════════
// CREATORS (Influencers / Analysts being tracked)
// ════════════════════════════════════════

model Creator {
  id              String      @id @default(cuid())
  slug            String      @unique
  displayName     String      @map("display_name")
  bio             String?
  profileImageUrl String?     @map("profile_image_url")
  isVerified      Boolean     @default(false) @map("is_verified")
  isClaimed       Boolean     @default(false) @map("is_claimed")
  isActive        Boolean     @default(true) @map("is_active")
  tier            CreatorTier @default(UNRATED)
  creatorType     CreatorType @default(INDIVIDUAL) @map("creator_type")

  specializations String[] @default([])

  totalTips     Int @default(0) @map("total_tips")
  activeTips    Int @default(0) @map("active_tips")
  completedTips Int @default(0) @map("completed_tips")
  followerCount Int @default(0) @map("follower_count")

  // V2: Community engagement stats
  internalFollows    Int    @default(0) @map("internal_follows")
  avgCommunityRating Float? @map("avg_community_rating")
  reviewCount        Int    @default(0) @map("review_count")

  firstTipAt DateTime? @map("first_tip_at")
  lastTipAt  DateTime? @map("last_tip_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  platforms         CreatorPlatform[]
  tips              Tip[]
  currentScore      CreatorScore?      @relation("CurrentScore")
  scoreSnapshots    ScoreSnapshot[]
  moderationActions ModerationAction[]

  // V2 Relations
  claimedBy         User?              @relation("ClaimedBy")
  follows           Follow[]
  reviews           CreatorReview[]

  @@index([slug])
  @@index([tier])
  @@index([totalTips])
  @@index([isActive])
  @@index([creatorType])
  @@index([createdAt])
  @@map("creators")
}

enum CreatorType {
  INDIVIDUAL
  BROKERAGE
  RESEARCH_FIRM
  NEWS_OUTLET
}

enum CreatorTier {
  UNRATED
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

// ════════════════════════════════════════
// CREATOR PLATFORMS (Social media accounts)
// ════════════════════════════════════════

model CreatorPlatform {
  id             String   @id @default(cuid())
  creatorId      String   @map("creator_id")
  platform       Platform
  platformUserId String   @map("platform_user_id")
  platformHandle String   @map("platform_handle")
  platformUrl    String   @map("platform_url")
  followerCount  Int      @default(0) @map("follower_count")
  isActive       Boolean  @default(true) @map("is_active")
  lastScrapedAt  DateTime? @map("last_scraped_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  creator  Creator   @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  rawPosts RawPost[]

  @@unique([platform, platformUserId])
  @@index([creatorId])
  @@index([platform])
  @@map("creator_platforms")
}

enum Platform {
  TWITTER
  YOUTUBE
  TELEGRAM
  WEBSITE
  FINNHUB
  STOCKTWITS
  YAHOO_FINANCE
}

// ════════════════════════════════════════
// RAW POSTS (Scraped social media posts before parsing)
// ════════════════════════════════════════

model RawPost {
  id                String   @id @default(cuid())
  creatorPlatformId String   @map("creator_platform_id")
  platformPostId    String   @map("platform_post_id")
  content           String
  mediaUrls         String[] @default([]) @map("media_urls")
  postedAt          DateTime @map("posted_at")
  scrapedAt         DateTime @default(now()) @map("scraped_at")
  isParsed          Boolean  @default(false) @map("is_parsed")
  isTipContent      Boolean? @map("is_tip_content")
  parseConfidence   Float?   @map("parse_confidence")
  metadata          Json?

  // Relations
  creatorPlatform CreatorPlatform @relation(fields: [creatorPlatformId], references: [id], onDelete: Cascade)
  tips            Tip[]

  @@unique([creatorPlatformId, platformPostId])
  @@index([isParsed])
  @@index([isTipContent])
  @@index([postedAt])
  @@map("raw_posts")
}

// ════════════════════════════════════════
// STOCKS (Master stock list)
// ════════════════════════════════════════

model Stock {
  id          String     @id @default(cuid())
  symbol      String     @unique
  exchange    Exchange
  name        String
  sector      String?
  industry    String?
  marketCap   MarketCap? @map("market_cap")
  isIndex     Boolean    @default(false) @map("is_index")
  isActive    Boolean    @default(true) @map("is_active")
  lastPrice   Float?     @map("last_price")
  lastPriceAt DateTime?  @map("last_price_at")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  tips           Tip[]
  priceHistory   StockPrice[]
  consensusData  AnalystConsensus[]

  @@index([symbol])
  @@index([exchange])
  @@index([isActive])
  @@map("stocks")
}

enum Exchange {
  // Americas
  NYSE
  NASDAQ
  TSX
  // Europe
  LSE
  XETRA
  EURONEXT
  // Asia-Pacific
  NSE
  BSE
  TSE
  HKEX
  ASX
  KRX
  SGX
  // Other
  MCX
  CRYPTO
  INDEX
}

enum MarketCap {
  LARGE
  MID
  SMALL
  MICRO
}

// ════════════════════════════════════════
// STOCK PRICES (Historical price data)
// ════════════════════════════════════════

model StockPrice {
  id      String   @id @default(cuid())
  stockId String   @map("stock_id")
  date    DateTime @db.Date
  open    Float
  high    Float
  low     Float
  close   Float
  volume  BigInt?
  source  String   @default("YAHOO")

  // Relations
  stock Stock @relation(fields: [stockId], references: [id], onDelete: Cascade)

  @@unique([stockId, date])
  @@index([stockId, date(sort: Desc)])
  @@map("stock_prices")
}

// ════════════════════════════════════════
// ANALYST CONSENSUS (Aggregate analyst sentiment per stock)
// ════════════════════════════════════════

model AnalystConsensus {
  id               String    @id @default(cuid())
  stockId          String    @map("stock_id")
  source           String    // "FINNHUB" | "YAHOO_FINANCE"
  strongBuy        Int       @default(0) @map("strong_buy")
  buy              Int       @default(0)
  hold             Int       @default(0)
  sell             Int       @default(0)
  strongSell       Int       @default(0) @map("strong_sell")
  targetHigh       Float?    @map("target_high")
  targetLow        Float?    @map("target_low")
  targetMean       Float?    @map("target_mean")
  targetMedian     Float?    @map("target_median")
  numberOfAnalysts Int?      @map("number_of_analysts")
  period           DateTime? @db.Date
  fetchedAt        DateTime  @default(now()) @map("fetched_at")
  rawData          Json?     @map("raw_data")

  // Relations
  stock Stock @relation(fields: [stockId], references: [id], onDelete: Cascade)

  @@unique([stockId, source, period])
  @@index([stockId, source])
  @@index([fetchedAt(sort: Desc)])
  @@map("analyst_consensus")
}

// ════════════════════════════════════════
// TIPS (The core entity — IMMUTABLE after creation)
// ════════════════════════════════════════

model Tip {
  id        String  @id @default(cuid())
  creatorId String  @map("creator_id")
  stockId   String  @map("stock_id")
  rawPostId String? @map("raw_post_id")

  // Immutable Tip Data
  direction  TipDirection
  assetClass AssetClass   @map("asset_class")
  entryPrice Float        @map("entry_price")
  target1    Float
  target2    Float?
  target3    Float?
  stopLoss   Float        @map("stop_loss")
  timeframe  TipTimeframe
  conviction Conviction   @default(MEDIUM)
  rationale  String?
  sourceUrl  String?      @map("source_url")

  // Integrity Fields
  contentHash String   @unique @map("content_hash")
  tipTimestamp DateTime @map("tip_timestamp")
  priceAtTip  Float?   @map("price_at_tip")

  // Mutable Status Fields
  status          TipStatus @default(PENDING_REVIEW)
  statusUpdatedAt DateTime? @map("status_updated_at")
  target1HitAt    DateTime? @map("target1_hit_at")
  target2HitAt    DateTime? @map("target2_hit_at")
  target3HitAt    DateTime? @map("target3_hit_at")
  stopLossHitAt   DateTime? @map("stoploss_hit_at")
  expiresAt       DateTime  @map("expires_at")
  closedPrice     Float?    @map("closed_price")
  closedAt        DateTime? @map("closed_at")

  // Computed Performance
  returnPct       Float? @map("return_pct")
  riskRewardRatio Float? @map("risk_reward_ratio")
  maxDrawdownPct  Float? @map("max_drawdown_pct")

  // Review Fields
  reviewStatus    ReviewStatus @default(PENDING) @map("review_status")
  reviewedAt      DateTime?    @map("reviewed_at")
  reviewNote      String?      @map("review_note")
  parseConfidence Float?       @map("parse_confidence")

  // V2: Engagement stats (denormalized, updated by background jobs)
  avgRating    Float?    @default(0) @map("avg_rating")
  ratingCount  Int       @default(0) @map("rating_count")
  commentCount Int       @default(0) @map("comment_count")
  viewCount    Int       @default(0) @map("view_count")
  saveCount    Int       @default(0) @map("save_count")
  feedScore    Float?    @map("feed_score")
  source       TipSource @default(SCRAPED)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  creator       Creator        @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  stock         Stock          @relation(fields: [stockId], references: [id])
  rawPost       RawPost?       @relation(fields: [rawPostId], references: [id])
  amendments    TipAmendment[]
  reviewActions ReviewAction[]

  // V2 Relations
  ratings          TipRating[]
  comments         Comment[]
  savedBy          SavedTip[]
  explanation      TipExplanation?
  portfolioEntries PortfolioEntry[]

  @@index([creatorId, status])
  @@index([creatorId, tipTimestamp(sort: Desc)])
  @@index([stockId, tipTimestamp(sort: Desc)])
  @@index([status])
  @@index([reviewStatus])
  @@index([expiresAt])
  @@index([tipTimestamp(sort: Desc)])
  @@index([feedScore(sort: Desc)])
  @@map("tips")
}

enum TipDirection {
  BUY
  SELL
}

enum AssetClass {
  EQUITY
  INDEX
  FUTURES
  OPTIONS
  CRYPTO
  COMMODITY
  FOREX
}

enum TipTimeframe {
  INTRADAY
  SWING
  POSITIONAL
  LONG_TERM
}

enum Conviction {
  LOW
  MEDIUM
  HIGH
}

enum TipStatus {
  PENDING_REVIEW
  ACTIVE
  TARGET_1_HIT
  TARGET_2_HIT
  TARGET_3_HIT
  ALL_TARGETS_HIT
  STOPLOSS_HIT
  EXPIRED
  REJECTED
}

enum ReviewStatus {
  PENDING
  AUTO_APPROVED
  MANUALLY_APPROVED
  REJECTED
  NEEDS_EDIT
}

// ════════════════════════════════════════
// TIP AMENDMENTS (Logged changes — for transparency)
// ════════════════════════════════════════

model TipAmendment {
  id        String   @id @default(cuid())
  tipId     String   @map("tip_id")
  field     String
  oldValue  String   @map("old_value")
  newValue  String   @map("new_value")
  reason    String?
  amendedAt DateTime @default(now()) @map("amended_at")

  // Relations
  tip Tip @relation(fields: [tipId], references: [id], onDelete: Cascade)

  @@index([tipId])
  @@map("tip_amendments")
}

// ════════════════════════════════════════
// CREATOR SCORES (Current score — one per creator)
// ════════════════════════════════════════

model CreatorScore {
  id                String @id @default(cuid())
  creatorId         String @unique @map("creator_id")

  // Component Scores (0-100 each)
  accuracyScore     Float @map("accuracy_score")
  riskAdjustedScore Float @map("risk_adjusted_score")
  consistencyScore  Float @map("consistency_score")
  volumeFactorScore Float @map("volume_factor_score")

  // Composite Score
  rmtScore           Float @map("rmt_score")
  confidenceInterval Float @map("confidence_interval")

  // Raw Metrics
  accuracyRate       Float @map("accuracy_rate")
  avgReturnPct       Float @map("avg_return_pct")
  avgRiskRewardRatio Float @map("avg_risk_reward_ratio")
  winStreak          Int   @default(0) @map("win_streak")
  lossStreak         Int   @default(0) @map("loss_streak")
  bestTipReturnPct   Float? @map("best_tip_return_pct")
  worstTipReturnPct  Float? @map("worst_tip_return_pct")

  // Breakdown by Timeframe
  intradayAccuracy   Float? @map("intraday_accuracy")
  swingAccuracy      Float? @map("swing_accuracy")
  positionalAccuracy Float? @map("positional_accuracy")
  longTermAccuracy   Float? @map("long_term_accuracy")

  // Metadata
  totalScoredTips  Int      @map("total_scored_tips")
  scorePeriodStart DateTime @map("score_period_start")
  scorePeriodEnd   DateTime @map("score_period_end")
  calculatedAt     DateTime @map("calculated_at")

  // Relations
  creator Creator @relation("CurrentScore", fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([rmtScore(sort: Desc)])
  @@index([accuracyRate(sort: Desc)])
  @@map("creator_scores")
}

// ════════════════════════════════════════
// SCORE SNAPSHOTS (Daily score history for charts)
// ════════════════════════════════════════

model ScoreSnapshot {
  id              String   @id @default(cuid())
  creatorId       String   @map("creator_id")
  date            DateTime @db.Date
  rmtScore        Float    @map("rmt_score")
  accuracyRate    Float    @map("accuracy_rate")
  totalScoredTips Int      @map("total_scored_tips")

  // Relations
  creator Creator @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([creatorId, date])
  @@index([creatorId, date(sort: Desc)])
  @@map("score_snapshots")
}

// ════════════════════════════════════════
// SCRAPE JOBS (Job tracking for scrapers)
// ════════════════════════════════════════

model ScrapeJob {
  id                String        @id @default(cuid())
  platform          Platform
  jobType           ScrapeJobType @map("job_type")
  status            JobStatus     @default(QUEUED)
  creatorPlatformId String?       @map("creator_platform_id")
  postsFound        Int           @default(0) @map("posts_found")
  tipsExtracted     Int           @default(0) @map("tips_extracted")
  errorMessage      String?       @map("error_message")
  startedAt         DateTime?     @map("started_at")
  completedAt       DateTime?     @map("completed_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  metadata          Json?

  @@index([status])
  @@index([platform])
  @@index([createdAt(sort: Desc)])
  @@map("scrape_jobs")
}

enum ScrapeJobType {
  FULL_SCRAPE
  INCREMENTAL
  SINGLE_CREATOR
  BACKFILL
}

enum JobStatus {
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// ════════════════════════════════════════
// REVIEW ACTIONS (Audit trail for human reviews)
// ════════════════════════════════════════

model ReviewAction {
  id        String           @id @default(cuid())
  tipId     String           @map("tip_id")
  adminId   String           @map("admin_id")
  action    ReviewActionType
  note      String?
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  tip   Tip       @relation(fields: [tipId], references: [id], onDelete: Cascade)
  admin AdminUser @relation(fields: [adminId], references: [id])

  @@index([tipId])
  @@index([adminId])
  @@map("review_actions")
}

enum ReviewActionType {
  APPROVED
  REJECTED
  EDITED_AND_APPROVED
  SENT_BACK_FOR_REVIEW
}

// ════════════════════════════════════════
// MODERATION ACTIONS (Creator-level moderation)
// ════════════════════════════════════════

model ModerationAction {
  id        String         @id @default(cuid())
  creatorId String         @map("creator_id")
  adminId   String         @map("admin_id")
  action    ModerationType
  reason    String
  createdAt DateTime       @default(now()) @map("created_at")

  // Relations
  creator Creator   @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  admin   AdminUser @relation(fields: [adminId], references: [id])

  @@index([creatorId])
  @@map("moderation_actions")
}

enum ModerationType {
  ACTIVATED
  DEACTIVATED
  FLAGGED
  UNFLAGGED
  NOTE_ADDED
}

// ════════════════════════════════════════
// V2 ENUMS
// ════════════════════════════════════════

enum UserRole {
  CONSUMER
  CREATOR
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

enum ReportReason {
  SPAM
  HARASSMENT
  MISLEADING
  OTHER
}

enum ReportStatus {
  PENDING_REPORT
  REVIEWED
  ACTIONED
  DISMISSED
}

enum TipSource {
  SCRAPED
  DIRECT
  MANUAL
}

// ════════════════════════════════════════
// USERS (Public user accounts — consumers + creators)
// ════════════════════════════════════════

model User {
  id                     String           @id @default(cuid())
  email                  String           @unique
  emailVerified          DateTime?        @map("email_verified")
  emailVerificationToken String?          @unique @map("email_verification_token")
  passwordHash           String?          @map("password_hash")
  displayName            String           @map("display_name")
  username               String           @unique
  avatarUrl              String?          @map("avatar_url")
  role                   UserRole         @default(CONSUMER)
  isActive               Boolean          @default(true) @map("is_active")
  isBanned               Boolean          @default(false) @map("is_banned")
  banReason              String?          @map("ban_reason")
  claimedCreatorId       String?          @unique @map("claimed_creator_id")
  subscriptionTier       SubscriptionTier @default(FREE) @map("subscription_tier")
  stripeCustomerId       String?          @unique @map("stripe_customer_id")
  createdAt              DateTime         @default(now()) @map("created_at")
  updatedAt              DateTime         @updatedAt @map("updated_at")

  // Relations
  claimedCreator      Creator?           @relation("ClaimedBy", fields: [claimedCreatorId], references: [id])
  oauthAccounts       OAuthAccount[]
  tipRatings          TipRating[]
  comments            Comment[]
  commentVotes        CommentVote[]
  savedTips           SavedTip[]
  follows             Follow[]
  creatorReviews      CreatorReview[]
  claimRequests       ClaimRequest[]
  notifications       Notification[]
  passwordResetTokens PasswordResetToken[]
  subscriptions       Subscription[]
  payments            Payment[]
  portfolios          Portfolio[]
  preferences         UserPreference?
  recommendationLogs  RecommendationLog[]

  @@index([username])
  @@index([email])
  @@index([subscriptionTier])
  @@map("users")
}

// ════════════════════════════════════════
// OAUTH ACCOUNTS (Google, Twitter login)
// ════════════════════════════════════════

model OAuthAccount {
  id                String    @id @default(cuid())
  userId            String    @map("user_id")
  provider          String
  providerAccountId String    @map("provider_account_id")
  accessToken       String?   @map("access_token")
  refreshToken      String?   @map("refresh_token")
  expiresAt         DateTime? @map("expires_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("oauth_accounts")
}

// ════════════════════════════════════════
// TIP RATINGS (1-5 star ratings on tips)
// ════════════════════════════════════════

model TipRating {
  id        String   @id @default(cuid())
  tipId     String   @map("tip_id")
  userId    String   @map("user_id")
  rating    Int      // 1-5
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tip  Tip  @relation(fields: [tipId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tipId, userId])
  @@index([tipId])
  @@map("tip_ratings")
}

// ════════════════════════════════════════
// COMMENTS (Threaded comments on tips)
// ════════════════════════════════════════

model Comment {
  id        String   @id @default(cuid())
  tipId     String   @map("tip_id")
  userId    String   @map("user_id")
  parentId  String?  @map("parent_id")
  content   String   // max 1000 chars enforced at app level
  isPinned  Boolean  @default(false) @map("is_pinned")
  isDeleted Boolean  @default(false) @map("is_deleted")
  isHidden  Boolean  @default(false) @map("is_hidden")
  upvotes   Int      @default(0)
  downvotes Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tip     Tip            @relation(fields: [tipId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent  Comment?       @relation("CommentReplies", fields: [parentId], references: [id])
  replies Comment[]      @relation("CommentReplies")
  votes   CommentVote[]
  reports CommentReport[]

  @@index([tipId, createdAt(sort: Desc)])
  @@index([tipId, upvotes(sort: Desc)])
  @@index([parentId])
  @@map("comments")
}

// ════════════════════════════════════════
// COMMENT VOTES (Upvote/downvote on comments)
// ════════════════════════════════════════

model CommentVote {
  id        String   @id @default(cuid())
  commentId String   @map("comment_id")
  userId    String   @map("user_id")
  voteType  VoteType @map("vote_type")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@map("comment_votes")
}

// ════════════════════════════════════════
// COMMENT REPORTS (Report abuse on comments)
// ════════════════════════════════════════

model CommentReport {
  id         String       @id @default(cuid())
  commentId  String       @map("comment_id")
  reporterId String       @map("reporter_id")
  reason     ReportReason
  details    String?
  status     ReportStatus @default(PENDING_REPORT)
  createdAt  DateTime     @default(now()) @map("created_at")

  // Relations
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("comment_reports")
}

// ════════════════════════════════════════
// SAVED TIPS (Bookmarks)
// ════════════════════════════════════════

model SavedTip {
  id        String   @id @default(cuid())
  tipId     String   @map("tip_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  tip  Tip  @relation(fields: [tipId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tipId, userId])
  @@map("saved_tips")
}

// ════════════════════════════════════════
// FOLLOWS (User follows Creator)
// ════════════════════════════════════════

model Follow {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  creatorId String   @map("creator_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  creator Creator @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([userId, creatorId])
  @@index([creatorId])
  @@map("follows")
}

// ════════════════════════════════════════
// CREATOR REVIEWS (User reviews on creator profiles)
// ════════════════════════════════════════

model CreatorReview {
  id        String   @id @default(cuid())
  creatorId String   @map("creator_id")
  userId    String   @map("user_id")
  rating    Int      // 1-5
  content   String?  // max 2000 chars enforced at app level
  isHidden  Boolean  @default(false) @map("is_hidden")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  creator Creator @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([creatorId, userId])
  @@index([creatorId, createdAt(sort: Desc)])
  @@map("creator_reviews")
}

// ════════════════════════════════════════
// CLAIM REQUESTS (Creator profile claiming workflow)
// ════════════════════════════════════════

model ClaimRequest {
  id               String       @id @default(cuid())
  userId           String       @map("user_id")
  creatorId        String       @map("creator_id")
  status           ClaimStatus  @default(PENDING)
  proofUrl         String       @map("proof_url") // Link to social profile proving ownership
  verificationNote String?      @map("verification_note") // User's note about why they own this profile
  reviewNote       String?      @map("review_note") // Admin's note on review decision
  reviewedBy       String?      @map("reviewed_by")
  reviewedAt       DateTime?    @map("reviewed_at")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relations
  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewer AdminUser? @relation(fields: [reviewedBy], references: [id])

  @@unique([userId, creatorId])
  @@index([status])
  @@index([creatorId])
  @@map("claim_requests")
}

enum ClaimStatus {
  PENDING
  APPROVED
  REJECTED
}

// ════════════════════════════════════════
// TIP EXPLANATIONS (Creator-written analysis)
// ════════════════════════════════════════

model TipExplanation {
  id        String   @id @default(cuid())
  tipId     String   @unique @map("tip_id")
  creatorId String   @map("creator_id")
  content   String   // Markdown content
  imageUrls String[] @default([]) @map("image_urls")
  version   Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tip Tip @relation(fields: [tipId], references: [id], onDelete: Cascade)

  @@map("tip_explanations")
}

// ════════════════════════════════════════
// NOTIFICATIONS (In-app notifications for users)
// ════════════════════════════════════════

model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  body      String
  actionUrl String?          @map("action_url")
  isRead    Boolean          @default(false) @map("is_read")
  readAt    DateTime?        @map("read_at")
  metadata  Json?
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt(sort: Desc)])
  @@map("notifications")
}

enum NotificationType {
  TIP_STATUS_CHANGED
  NEW_TIP_FROM_FOLLOWED
  CLAIM_APPROVED
  CLAIM_REJECTED
  COMMENT_REPLY
  SUBSCRIPTION_EXPIRING
  PORTFOLIO_ALERT
}

// ════════════════════════════════════════
// PASSWORD RESET TOKENS
// ════════════════════════════════════════

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  tokenHash String    @unique @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_reset_tokens")
}

// ════════════════════════════════════════
// V3 ENUMS
// ════════════════════════════════════════

enum SubscriptionTier {
  FREE
  PRO
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
}

enum PaymentStatus {
  SUCCEEDED
  FAILED
  REFUNDED
}

enum PortfolioEntryStatus {
  OPEN
  CLOSED
}

enum RiskTolerance {
  LOW
  MODERATE
  HIGH
}

// ════════════════════════════════════════
// SUBSCRIPTIONS (Stripe-managed billing)
// ════════════════════════════════════════

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @map("user_id")
  stripeSubscriptionId String             @unique @map("stripe_subscription_id")
  stripePriceId        String             @map("stripe_price_id")
  tier                 SubscriptionTier
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime           @map("current_period_start")
  currentPeriodEnd     DateTime           @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  canceledAt           DateTime?          @map("canceled_at")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

// ════════════════════════════════════════
// PAYMENTS (Stripe payment history)
// ════════════════════════════════════════

model Payment {
  id                     String        @id @default(cuid())
  userId                 String        @map("user_id")
  stripePaymentIntentId  String        @unique @map("stripe_payment_intent_id")
  amount                 Int           // in smallest currency unit (cents/paise)
  currency               String        @default("usd")
  status                 PaymentStatus @default(SUCCEEDED)
  description            String?
  createdAt              DateTime      @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("payments")
}

// ════════════════════════════════════════
// PORTFOLIOS (User-created tip portfolios)
// ════════════════════════════════════════

model Portfolio {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  name      String   @default("My Portfolio")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  entries   PortfolioEntry[]
  snapshots PortfolioSnapshot[]

  @@index([userId])
  @@map("portfolios")
}

// ════════════════════════════════════════
// PORTFOLIO ENTRIES (Tracked positions from tips)
// ════════════════════════════════════════

model PortfolioEntry {
  id             String               @id @default(cuid())
  portfolioId    String               @map("portfolio_id")
  tipId          String               @map("tip_id")
  status         PortfolioEntryStatus @default(OPEN)
  entryPrice     Float                @map("entry_price")
  quantity       Float                @default(1)
  closedPrice    Float?               @map("closed_price")
  closedAt       DateTime?            @map("closed_at")
  unrealizedPnl  Float?               @map("unrealized_pnl")
  realizedPnl    Float?               @map("realized_pnl")
  notes          String?
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")

  // Relations
  portfolio Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  tip       Tip       @relation(fields: [tipId], references: [id])

  @@unique([portfolioId, tipId])
  @@index([portfolioId, status])
  @@map("portfolio_entries")
}

// ════════════════════════════════════════
// PORTFOLIO SNAPSHOTS (Daily value history)
// ════════════════════════════════════════

model PortfolioSnapshot {
  id          String   @id @default(cuid())
  portfolioId String   @map("portfolio_id")
  date        DateTime @db.Date
  totalValue  Float    @map("total_value")
  totalPnl    Float    @map("total_pnl")
  openCount   Int      @map("open_count")

  // Relations
  portfolio Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@unique([portfolioId, date])
  @@index([portfolioId, date(sort: Desc)])
  @@map("portfolio_snapshots")
}

// ════════════════════════════════════════
// USER PREFERENCES (For AI recommendations)
// ════════════════════════════════════════

model UserPreference {
  id                   String        @id @default(cuid())
  userId               String        @unique @map("user_id")
  preferredTimeframes  String[]      @default([]) @map("preferred_timeframes")
  preferredAssetClasses String[]     @default([]) @map("preferred_asset_classes")
  riskTolerance        RiskTolerance @default(MODERATE) @map("risk_tolerance")
  minCreatorScore      Float?        @map("min_creator_score")
  preferredSectors     String[]      @default([]) @map("preferred_sectors")
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// ════════════════════════════════════════
// RECOMMENDATION LOGS (Pre-computed recommendations)
// ════════════════════════════════════════

model RecommendationLog {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  type        String   // "TIP" or "CREATOR"
  referenceId String   @map("reference_id") // tip ID or creator ID
  score       Float    // recommendation score
  reason      String?  // human-readable explanation
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@index([createdAt(sort: Desc)])
  @@map("recommendation_logs")
}
